!
hostname BORDER2
!
spanning-tree mode mstp
no spanning-tree vlan-id 3001-3002,4094
spanning-tree edge-port bpduguard default
spanning-tree mst 0 priority 0
!
service routing protocols model multi-agent
!
vlan 100
  name FW-OUTSIDE_VLAN
!
vlan 200
  name FW-INSIDE_VLAN

vlan 300
  name CORE_CONNECTION
!
vlan 3001
  name MLAG_PEER_VRF_FW-OUTSIDE
  trunk group MLAG_PEER
!
vlan 3002
  name MLAG_PEER_VRF_FW-INSIDE
  trunk group MLAG_PEER
!
!
vlan 4094
  name MLAG_PEER_SYNC
  trunk group MLAG_PEER
!
vrf instance FW-OUTSIDE
!
vrf instance FW-INSIDE
!
interface Port-Channel 11
  description OUTSIDE_FIREWALL1
  switchport mode trunk
  mlag 11
!
interface Port-Channel 12
  description OUTSIDE_FIREWALL2
  switchport mode trunk
  mlag 12
!
interface Port-Channel 21
  description INSIDE_FIREWALL1
  switchport mode trunk
  mlag 21
!
interface Port-Channel 22
  description INSIDE_FIREWALL2
  switchport mode trunk
  mlag 22
!
interface Port-Channel1000
  description MLAG PEER LINK
  switchport mode trunk
  switchport trunk group MLAG_PEER
!

interface Port-Channel 31
  description core
  switchport mode trunk
  mlag 31

interface Ethernet 1
  description OUTSIDE_FIREWALL1_Eth2
  channel-group 11 mode active
!
interface Ethernet 2
  description OUTSIDE_FIREWALL2_Eth2
  channel-group 12 mode active
!
interface Ethernet 3
  description INSIDE_FIREWALL1_Eth4
  channel-group 21 mode active
!
interface Ethernet 4
  description INSIDE_FIREWALL2_Eth4
  channel-group 22 mode active
!
interface Ethernet5
  channel-group 1000 mode active
!
interface Ethernet6
  channel-group 1000 mode active

interface Ethernet7
  channel-group 31 mode active

interface Ethernet 8
no switchport
vrf FW-OUTSIDE
ip add 172.16.20.1/30
ip nat source dynamic access-list INSIDE_HOSTS overload
no shu
!
interface Vlan100
  vrf FW-OUTSIDE
  ip address 172.16.1.3/29
  ip virtual-router address 172.16.1.1
!
interface Vlan200
  vrf FW-INSIDE
  ip address 172.16.2.3/29
  ip virtual-router address 172.16.2.1
!

interface Vlan300
  vrf FW-INSIDE
  ip address 172.16.3.3/29
  ip virtual-router address 172.16.3.1


interface Vlan3001
  description MLAG iBGP Peer - VRF FW-OUTSIDE
  no autostate
  vrf FW-OUTSIDE
  ip address 192.0.0.1/31
!
interface Vlan3002
  description MLAG iBGP Peer - VRF FW-INSIDE
  no autostate
  vrf FW-INSIDE
  ip address 192.0.0.1/31
!

!
interface Vlan4094
  description MLAG PEER SYNC
  no autostate
  ip address 169.254.0.2/30
!
mac address-table aging-time 1800
!
ip virtual-router mac-address 00:1c:73:00:00:01
!
ip routing
!
ip routing vrf FW-OUTSIDE
ip routing vrf FW-INSIDE
!
route-map TO-FW-OUTSIDE permit 10
  set ip next-hop 172.16.1.1
!
route-map TO-FW-INSIDE permit 10
  set ip next-hop 172.16.2.1

route-map DENY_ALL deny 10

!
mlag configuration
  domain-id BORDER
  local-interface Vlan4094
  peer-address 169.254.0.1
  peer-link Port-Channel1000
!
router bgp 65000
  router-id 2.2.2.2
  no bgp default ipv4-unicast
  distance bgp 20 200 200
  graceful-restart restart-time 300
  graceful-restart
  maximum-paths 4

  neighbor FW-PEERS-OUTSIDE peer group
  neighbor FW-PEERS-OUTSIDE graceful-restart
  neighbor FW-PEERS-OUTSIDE remote-as 65002
  neighbor FW-PEERS-OUTSIDE route-map TO-FW-OUTSIDE out

  neighbor FW-PEERS-INSIDE peer group
  neighbor FW-PEERS-INSIDE graceful-restart
  neighbor FW-PEERS-INSIDE remote-as 65002
  neighbor FW-PEERS-INSIDE route-map TO-FW-INSIDE out

  neighbor MLAG-IPV4-PEER peer group
  neighbor MLAG-IPV4-PEER remote-as 65000
  neighbor MLAG-IPV4-PEER next-hop-self
  neighbor MLAG-IPV4-PEER password 7 CRkxra9QRmU5k9/wECPlUA==

  neighbor ISP peer group
  neighbor ISP graceful-restart
  neighbor ISP remote-as 20
  neighbor ISP route-map DENY_ALL out

  neighbor core peer group
  neighbor core graceful-restart
  neighbor core remote-as 65003
  !
  address-family ipv4
      neighbor FW-PEERS-OUTSIDE activate
      neighbor FW-PEERS-INSIDE activate
      neighbor MLAG-IPV4-PEER activate
      neighbor ISP activate
      neighbor core activate
  !
  !
  vrf FW-OUTSIDE
    rd 2.2.2.2:1001
    router-id 172.16.1.3
    graceful-restart restart-time 300
    neighbor 172.16.1.4 peer group FW-PEERS-OUTSIDE
    neighbor 192.0.0.0 peer group MLAG-IPV4-PEER
    neighbor 172.16.20.2 peer group ISP
  !
  vrf FW-INSIDE
    rd 2.2.2.2:2001
    router-id 172.16.2.3
    graceful-restart restart-time 300
    neighbor 172.16.2.4 peer group FW-PEERS-INSIDE
    neighbor 192.0.0.0 peer group MLAG-IPV4-PEER
    neighbor 172.16.3.4 peer group core
!
username admin privilege 15 nopassword
!
aaa authentication policy local allow-nopassword-remote-login
!

ip access-list standard INSIDE_HOSTS
   10 permit any